<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <meta name="viewport" content="width=device-width">
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/styles.css">
  </head>
  <body>
    <div class="sidebar">
      <header>
        <h4>Salva</h4>
        <p>Ayudanos a que las personas tengan la mejor información posible para mitigar accidentes y colaborar con los mas necesitados.</p>

        <div id="firebaseui-auth-container"></div>
      </header>
      <main id="sidebar-main" style="display: none;">
        <a class="sidebar-link active" href="/admin">Agregar recorrido de huaico</a>
        <a class="sidebar-link" href="/cercos">Agregar cerco al mapa</a>
        <a class="sidebar-link" href="/ayuda">Registrar puntos de ayuda</a>
        <a class="sidebar-link" href="/refugio">Registrar refugio</a>
      </main>
      <footer class="sidebar-footer">
        <div id="login"></div>
      </footer>
    </div>
    <div id="map" class="main">
      
    </div>
    <script src="https://cdn.firebase.com/libs/firebaseui/2.7.0/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.7.0/firebaseui.css" />
    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
    <script>
      var data = {
        sender: null,
        timestamp: null,
        lat: null,
        lng: null
      };
      var config = {
        apiKey: "AIzaSyAx8vftg8OhXqkmE14k2PttH-eEbeegZmQ",
        authDomain: "salva-1524947678629.firebaseapp.com",
        databaseURL: "https://salva-1524947678629.firebaseio.com",
        projectId: "salva-1524947678629",
        storageBucket: "salva-1524947678629.appspot.com",
        messagingSenderId: "995333411158"
      };
      firebase.initializeApp(config);
      var database = firebase.database();

      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -8.095657, lng: -79.019415},
          zoom: 17,
          styles: [{
            featureType: 'poi',
            stylers: [{ visibility: 'off' }]  // Turn off points of interest.
          }, {
            featureType: 'transit.station',
            stylers: [{ visibility: 'off' }]  // Turn off bus stations, train stations, etc.
          }],
          disableDoubleClickZoom: true
        });

        var infoBoxDiv = document.createElement('div');
        var infoBox = new makeInfoBox(infoBoxDiv, map);
        infoBoxDiv.index = 1;
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(infoBoxDiv);

        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            // Logueado
            var isAnonymous = user.isAnonymous;
            var uid = user.uid;
            data.sender = uid;

            map.addListener('click', function(e) {
              data.lat = e.latLng.lat();
              data.lng = e.latLng.lng();
              data.created = new Date();
              firebase.database().ref('clicks/').push(data);
            });
          } else {
            // Deslogueado
          }
        });

        var heatmap = new google.maps.visualization.HeatmapLayer({
          data: [],
          map: map,
          radius: 16
        });

        var clicksRef = database.ref('clicks/');
        clicksRef.on('child_added', function(data) {
          var newPosition = data.val();
          var point = new google.maps.LatLng(newPosition.lat, newPosition.lng);
          heatmap.getData().push(point);
        });
      }

      function makeInfoBox(controlDiv, map) {
        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.boxShadow = 'rgba(0, 0, 0, 0.298039) 0px 1px 4px -1px';
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '2px';
        controlUI.style.marginBottom = '22px';
        controlUI.style.marginTop = '10px';
        controlUI.style.textAlign = 'center';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
        controlText.style.fontSize = '100%';
        controlText.style.padding = '6px';
        controlText.innerText = 'The map shows all clicks made in the last 10 minutes.';
        controlUI.appendChild(controlText);
      }

      // ini app
      initApp = function() {
        firebase.auth().languageCode = 'es';
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            console.log(user);
            var uid = user.uid;
            var phoneNumber = user.phoneNumber;
            var providerData = user.providerData;
            user.getIdToken().then(function(accessToken) {
              document.getElementById('login').textContent = 'Estas logueado con el número ' + phoneNumber;
              document.getElementById('sidebar-main').style.display = 'block';
            });
          } else {
            var uiConfig = {
              signInSuccessUrl: '/admin.html',
              signInOptions: [
                firebase.auth.PhoneAuthProvider.PROVIDER_ID
              ],
              // Terms of service url.
              tosUrl: '/terminos.html'
            };

            var ui = new firebaseui.auth.AuthUI(firebase.auth());
            ui.start('#firebaseui-auth-container', uiConfig);

            if (ui.isPendingRedirect()) {
              ui.start('#firebaseui-auth-container', uiConfig);
            }
          }
        }, function(error) {
          console.log(error);
        });
      };

      window.addEventListener('load', function() {
        initApp()
      });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzy9ELEuoVcZTNv4pBrW0kfk1L0Ua4Xkc&libraries=visualization&callback=initMap">
    </script>
    <script>
    </script>
  </body>
</html>